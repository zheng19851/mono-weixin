<?xml version="1.0" encoding="GB2312"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="WX_MESSAGE">

	<typeAlias alias="WXMessageAlias" type="com.kongur.monolith.weixin.core.message.domain.WXMessageDO" />

	<resultMap id="WXMessageResultMap" class="WXMessageAlias">
		<result column="id" property="id" />
		<result column="app_id" property="appId" />
		<result column="msg_id" property="msgId" />
		<result column="msg_type" property="msgType" />
		<result column="from_user" property="fromUser" />
		<result column="to_user" property="toUser" />
		<result column="create_time" property="createTime" />
		<result column="features" property="features" />
		<result column="status" property="status" />
		<result column="gmt_create" property="gmtCreate" />
		<result column="gmt_modify" property="gmtModify" />
	</resultMap>

	<sql id="WXMessage-columns-without-id">
		app_id, msg_id, msg_type, from_user, to_user, create_time, features, status, gmt_create, gmt_modify
	</sql>

	<insert id="WX_MESSAGE.insertMessage"  parameterClass="WXMessageAlias">
		INSERT INTO wx_message(<include refid="WXMessage-columns-without-id"/>)
		VALUES(#appId#, #msgId#, #msgType#, #fromUser#, #toUser#, #createTime#, #features#, #status#, now(), now())
		<selectKey resultClass="long" keyProperty="id">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<update id="WX_MESSAGE.updateMessage"  parameterClass="WXMessageAlias">
		UPDATE wx_message
		   SET
		   <dynamic prepend=" ">
				<isParameterPresent>
			   		<isNotEmpty  property="appId" prepend=" ">app_id = #appId#</isNotEmpty>
			   		<isNotEmpty  property="msgId" prepend=", ">msg_id = #msgId#</isNotEmpty>
			   		<isNotEmpty  property="msgType" prepend=", ">msg_type = #msgType#</isNotEmpty>
			   		<isNotEmpty  property="fromUser" prepend=", ">from_user = #fromUser#</isNotEmpty>
			   		<isNotEmpty  property="toUser" prepend=", ">to_user = #toUser#</isNotEmpty>
			   		<isNotEmpty  property="createTime" prepend=", ">create_time = #createTime#</isNotEmpty>
			   		<isNotEmpty  property="features" prepend=", ">features = #features#</isNotEmpty>
			   		<isNotEmpty  property="status" prepend=", ">status = #status#</isNotEmpty>
			   		<isNotEmpty  property="gmtCreate" prepend=", ">gmt_create = #gmtCreate#</isNotEmpty>
			   		<isNotEmpty  property="gmtModify" prepend=", ">gmt_modify = #gmtModify#</isNotEmpty>
				</isParameterPresent>
		   </dynamic>
	     WHERE id = #id#
	</update>

	<sql id="WX_MESSAGE.dynamicQuery">
                    <dynamic prepend="WHERE">
                        <isParameterPresent>
                            <isNotEmpty  property="appId" prepend="AND ">app_id = #appId#</isNotEmpty>
                            <isNotEmpty  property="msgId" prepend="AND ">msg_id = #msgId#</isNotEmpty>
                            <isNotEmpty  property="msgType" prepend="AND ">msg_type = #msgType#</isNotEmpty>
                            <isNotEmpty  property="fromUser" prepend="AND ">from_user = #fromUser#</isNotEmpty>
                            <isNotEmpty  property="toUser" prepend="AND ">to_user = #toUser#</isNotEmpty>
                            <isNotEmpty  property="createTime" prepend="AND ">create_time = #createTime#</isNotEmpty>
                            <isNotEmpty  property="status" prepend="AND ">status = #status#</isNotEmpty>
                        </isParameterPresent>
                    </dynamic>
	</sql>

  	<select id="WX_MESSAGE.selectMessage" resultMap="WXMessageResultMap" >
		SELECT  id, <include refid="WXMessage-columns-without-id"/>  FROM wx_message <include refid="WX_MESSAGE.dynamicQuery"/> 
  	</select>

  	<select id="WX_MESSAGE.selectMessageById" resultMap="WXMessageResultMap" parameterClass="java.lang.Long">
		SELECT  id, <include refid="WXMessage-columns-without-id"/>  FROM wx_message where id = #id#
  	</select>
  	
  	<select id="WX_MESSAGE.selectMessageByMsgId" resultMap="WXMessageResultMap" >
		SELECT  id, <include refid="WXMessage-columns-without-id"/> FROM wx_message where msg_id = #msgId#
  	</select>

    <select id="WX_MESSAGE.selectMessageForPagin" resultMap="WXMessageResultMap" >
        SELECT 
           t.id, t.app_id, t.msg_id, t.msg_type, t.from_user, t.to_user, t.create_time, t.features, t.status, t.gmt_create, t.gmt_modify
        FROM 
             (SELECT id FROM wx_message
<include refid="WX_MESSAGE.dynamicQuery"/>
        ORDER BY
                    gmt_create DESC
        LIMIT  #startRow#, #pageSize#) AS a, wx_message AS t
        FORCE INDEX(PRIMARY)
        WHERE a.id = t.id
    </select>

  	<select id="WX_MESSAGE.selectMessageForPaginCount" resultClass="java.lang.Integer">
		SELECT 
				count(1) 
		FROM wx_message
<include refid="WX_MESSAGE.dynamicQuery"/>
  	</select>

</sqlMap>